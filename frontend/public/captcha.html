<html>
  <head>
    <title>Harvester</title>
    <script src="./js/prevent.js"></script>
    <link rel="stylesheet" type="text/css" href="./css/captcha.css">
  </head>
  <body>
    <div id="titlebar"></div>
    <img src="./assets/close-captcha.svg" id="close-btn" onclick="window.Bridge.close()" />
    <div id="waiting">
      <div class="loader">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
    </div>
    <div id="captcha">
      <form action="/submit" method="post"></form>
    </div>
    <div class="footer">
      <button id="launch-youtube" onclick="window.Bridge.launchYoutube()" >Account</button>
      <button id="end-session" onclick="window.Bridge.endCaptchaSession()" >End Session</button>
    </div>
    <script>
      function submitCaptcha() {
        const token = document.getElementById('g-recaptcha-response').value;
        console.log('submit?');
        console.log(token);
        window.Bridge.harvestCaptchaToken(token);
        grecaptcha.reset();
        window.Bridge.refreshCaptchaWindow();
      }

      const _registerStartHandler = function(ev, runnerId) {
        // TODO: Remove this!
        console.log(`[DEBUG]: Starting token for runner: ${runnerId}`);
        const script = document.createElement('script');
        script.setAttribute('type', 'text/javascript');
        script.setAttribute('src', 'https://www.google.com/recaptcha/api.js');
        const div = document.createElement('div');
        div.innerHTML = `<div class="g-recaptcha" data-sitekey="${window.Bridge.getSitekey()}" data-callback="submitCaptcha"></div>`;
        const form = document.getElementsByTagName('form');
        form.appendChild(div);
        form.appendChild(script);
      }

      const _registerStopHandler = function(ev, runnerId) {
        // TODO: Remove this!
        console.log(`[DEBUG]: Stopping token for runner: ${runnerId}`);
        window.Bridge.refreshCaptchaWindow();
      }

      function registerForCaptchaEvents() {
        // TODO: Remove this!
        console.log('[DEBUG]: Registering for captcha events...');
        window.Bridge.Captcha.start.register(_registerStartHandler);
        window.Bridge.Captcha.stop.register(_registerStopHandler);
      }

      function deregisterForCaptchaEvents() {
        // TODO: Remove this!
        console.log('[DEBUG]: Deregistering for captcha events...');
        window.Bridge.Captcha.start.deregister(_registerStartHandler);
        window.Bridge.Captcha.stop.deregister(_registerStartHandler);
      }

      document.body.onload = () => {
        registerForCaptchaEvents();
      };

      document.body.onclose = () => {
        deregisterForCaptchaEvents();
      }
    </script>
  </body>
</html>
